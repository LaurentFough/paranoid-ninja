#!/bin/sh

die() {
  printf "${red}%s${white}%s${endc}\n" \
    "[-]" " $1"
  exit 1
}

checkRoot() {
  if [[ "$(id -u)" -ne 0 ]] ; then
    die "Please run this program as a root" 2>&1
  fi
}

#######################################################
# Command option

checkConfigFile() {
  local relativ full
  relativ="$DIR/$1"
  full="${1-:/etc/paranoid/paranoid.conf}"
  if [ -f "$relativ" ] ; then
    source "$relativ"
  elif [ -f "$full" ] ; then
    source "$full"
  else
    die "No config file found"
  fi
}

checkArgConfig() {
  [[ "$#" -eq 0 ]] && die "call $0 with -c paranoid.conf"
  while [ "$#" -gt 0 ] ; do
    case "$1" in 
      -c | --config)
        checkConfigFile $2
        shift
        ;;
      -- | -* | *)
        die "call $0 with -c paranoid.conf"
        ;;
    esac
    shift
  done
}

#######################################################
# Backup

backupFiles() {
  local b backup_list
  backup_list="$1"
  if [ $backup_dir ] ; then
    [[ ! -d $backup_dir ]] && mkdir -p $backup_dir
    # $f can be a directory or a file
    for b in $backup_list ; do
      if [[ -f "$backup_dir/${b##*/}" ]] ; then
        echo -n
      elif [[ -d "$backup_dir/${b##*/}" ]] ; then
        echo -n
      else
        echo "[*] backup $b to $backup_dir ..."
        cp -a "$b" "$backup_dir/"
      fi
    done
  else
    echo "[*] backup_dir is unset from config file, skip"
  fi
}

cpy() {
  local src dest
  src="$1"
  dest="$2"
  if [[ -f $src ]] || [[ -d $src ]] ; then
    echo "[+] cp -a $src $dest"
    cp -a $src $dest
  fi
}

restoreFiles() {
  local dir f
  dir=$backup_dir
  [[ -z $dir ]] && die "$dir no found"
  cpy $dir/hostname /etc/default/hostname
  cpy $dir/hosts /etc/hosts
  cpy $dir/resolv.conf /etc/resolv.conf
  cpy $dir/sysctl.conf /etc/sysctl.conf
  cpy $dir/torrc /etc/tor/torrc
  cpy $dir/.ssh $ssh_dir
  for f in $other_host_files ; do
    cpy $dir/${f##*/} $f
  done
}

#######################################################
# Firewall

nftReload() {
  local files f
  files="/var/lib/nftables/rules-save /etc/nftables.conf"
  for f in $files ; do
    if [ -f $f ] ; then
      $NFT flush ruleset
      $NFT -f $f
    fi
  done
}

iptReload() {
  local files f
  files="/var/lib/iptables/rules-save /etc/iptables/iptables.rules"
  for f in $files ; do
    if [ -f $f ] ; then
      $IPT_RES $f
    fi
  done
}

searchTorUid() {
  local tor_uid
  id -u debian-tor > /dev/null 2>&1
  [[ $? -eq 0 ]] && tor_uid=$(id -u debian-tor)

  id -u tor > /dev/null 2>&1
  [[ $? -eq 0 ]] && tor_uid=$(id -u tor)

  [[ -z $tor_uid ]] && die "tor_uid no found"
  echo $tor_uid
}

#######################################################
# Hostname

# Write the new hostname in file from $other_host_files
otherHostFiles() {
  local f rule
  rule="$1"
  if [ $other_host_files ] ; then
    for f in $other_host_files ; do
      [[ -f $f ]] &&
        sed -i "$rule" $f
    done
  fi
}

# forXorg, avoid error like display no found
# http://ubuntuhandbook.org/index.php/2016/06/change-hostname-ubuntu-16-04-without-restart/
XAUTH_COM="$XAUTH -f $xauthority_file"
addXauth() {
  local user
  user=$(echo ${xauthority_file%/*} | sed s:/home/::g)
  $XAUTH_COM add "$1" $2 $3 &&
  $XAUTH_COM remove "$4" &&
  chown $user:$user $xauthority_file || die "xauth - fail to change $xauthority_file"
}

checkXauth() {
  local dpy new_dpy proto hexkey new_host ifarg
  [[ ! -z $1 ]] && ifarg="$1" || ifarg="unix"
  new_host=$(cat /etc/hostname | head -n 1)
  dpy=$($XAUTH_COM list | grep $ifarg | awk '{print $1}')
  proto=$($XAUTH_COM list | grep $ifarg | awk '{print $2}')
  hexkey=$($XAUTH_COM list | grep $ifarg | awk '{print $3}')
  if [[ -z $dpy ]] || [[ -z $proto ]] || [[ -z $hexkey ]] ; then
    die "xauth - unable to find information on $xauthority_file with $ifarg"
  fi
  new_dpy="$(echo $dpy | sed s:${dpy%/*}:$new_host:g)"
  addXauth "$new_dpy" "$proto" "$hexkey" "$dpy"
}

forXauth() {
  local if_one old_host
  [[ -z $XAUTH ]] && die "xauth - xauth is no found ..."
  if [[ $xauthority_file ]] && [[ -f $xauthority_file ]] ; then
    if_one=$($XAUTH_COM list | wc -l)
    old_host="$1"
    if [[ $if_one == 1 ]] ; then
      echo "[+] xauth - changing the single entry..."
      checkXauth
    elif [[ $old_host ]] ; then
      echo "[+] xauth - there is more than one entry, check with $old_host"
      checkXauth "$old_host"
    else
      die "xauth - unable to change the hostname $old_host"
    fi
  else
    echo "[*] xauth - file $xauthority_file no found, skip..."
  fi
}

# exec if ssh_dir is set from conf file.
updSshKey() {
  local old new user file if_user_host
  user="$1"
  file="$2"
  old=$(grep $user $file | awk '{print $3}')
  new=$(cat /etc/hostname | head -n 1)
  if if_user_host=$(grep $user $file) ; then
    echo "[+] ssh - changed $user@$new at $file..."
    sed -i "s:$old:$user@$new:g" $file
  else
    echo "[+] ssh - changed $new at $file..."
    sed -i "s:$3:$new:g" $file
  fi
}

forSsh() {
  local user file pub_key if_pub_key f
  user=$(echo ${ssh_dir%/*} | sed s:/home/::g)
  file="$(find $ssh_dir -type f | xargs grep $user | awk '{print $1}')"
  pub_key="$(grep $user $ssh_dir/authorized_keys | awk '{print $2}')"
  for f in $file ; do
    updSshKey $user ${f%%:*}
  done
  if [[ $pub_key ]] && if_pub_key=$(grep ${pub_key:0:20} $ssh_dir/known_hosts | awk '{print $1}' | head -n 1) ; then
    echo "[*] ssh - found a old hostname in $ssh_dir/known_hosts"
    updSshKey $user $ssh_dir/known_hosts $if_pub_key
  fi
}

# Write new value of hostname in multiple files
writeHost() {
  local new old file files rule xorg
  # check if Xorg running
  xorg="$(pgrep -x Xorg)"
  # /etc/hostname
  new="$1"
  old="$(cat /etc/hostname | head -n 1)"
  files="/etc/hostname /etc/hosts"
  rule="s:$old:$new:g"
  for file in $files ; do
    sed -i "$rule" $file || die "sed 1"
  done
  forSsh
  [[ ! -z $xorg ]] && forXauth "$old"
  otherHostFiles "$rule"
  $HOSTNAME $new
}

#######################################################
# Check network

checkIp() {
  local external_ip ip_1 ip_2
  printf "%s %s\\n" \
    "==>" "Checking your public IP, please wait..."

  ip_1=$(curl -s -m 10 https://ipinfo.io)
  ip_2=$(curl -s -m 10 https://ip-api.com)
  if external_ip="$ip_1" || external_ip="$ip_2" ; then
    printf "%s\\n" "$external_ip" | tr -d '"{}' | sed 's/ //g'
  else
    printf "%s\\n" "[ failed ] curl: HTTP request error"
    exit 1
  fi
}

testTor() {
  local url
  url="https://check.torproject.org/"
  curl -s -m 10 -L "$url" | cat | tac | grep -q 'Congratulations'
  if [ $? -eq 0 ] ; then
    echo "[+] Tor is working properly"
    checkIp
  else
    echo "[-] Unfortunately, Tor is no working"
    exit 0
  fi
}

#######################################################
# Other Daemon

loadTor() {
  local if_tor
  if_tor=$(pgrep -x tor)
  if [[ -z $if_tor ]] ; then
    $SYSTEMCTL start tor &
    wait $!
  else
    echo "[+] Restarting tor ..."
    $SYSTEMCTL restart tor &
    wait $!
  fi
}
